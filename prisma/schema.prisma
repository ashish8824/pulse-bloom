// prisma/schema.prisma

datasource db {
  provider = "postgresql"
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

// ─────────────────────────────────────────────────────────────────
// USER
// ─────────────────────────────────────────────────────────────────
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())

  moods     MoodEntry[]
  habits    Habit[]
  aiInsight AiInsight?
}

// ─────────────────────────────────────────────────────────────────
// MOOD ENTRY
//
// Stores structured mood data in PostgreSQL.
// Journal text lives in MongoDB (JournalEntry) and is linked via journalId.
//
// Mood module endpoints:
//   POST   /api/mood                    → create
//   GET    /api/mood                    → paginated list
//   GET    /api/mood/:id                → single (hydrated with journal)
//   PATCH  /api/mood/:id                → update
//   DELETE /api/mood/:id                → delete
//   GET    /api/mood/analytics          → stats summary
//   GET    /api/mood/streak             → consecutive logging streak
//   GET    /api/mood/heatmap            → GitHub-style daily heatmap
//   GET    /api/mood/summary/monthly    → calendar month view
//   GET    /api/mood/insights/daily     → day-of-week + time-of-day patterns
//   GET    /api/mood/trends/weekly      → ISO week groupings
//   GET    /api/mood/trends/rolling     → 7-day rolling average
//   GET    /api/mood/burnout-risk       → burnout risk score
//
// Indexes:
//   @@index([userId])           → required for all user-scoped queries
//   @@index([userId, createdAt]) → required for date-range analytics queries
//                                  Without this, every analytics call full-scans
//                                  the table as the dataset grows.
// ─────────────────────────────────────────────────────────────────
model MoodEntry {
  id        String   @id @default(uuid())
  moodScore Int
  emoji     String
  journalId String?  // MongoDB ObjectId — null if no journal was provided
  userId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
}

// ─────────────────────────────────────────────────────────────────
// HABIT
// ─────────────────────────────────────────────────────────────────
enum HabitFrequency {
  daily
  weekly
}

enum HabitCategory {
  health
  fitness
  learning
  mindfulness
  productivity
  custom
}

model Habit {
  id            String         @id @default(uuid())
  title         String
  description   String?
  frequency     HabitFrequency
  category      HabitCategory  @default(custom)
  color         String?
  icon          String?
  targetPerWeek Int?
  sortOrder     Int            @default(0)
  isArchived    Boolean        @default(false)
  reminderTime  String?        // "HH:MM" — matched by cron job every minute
  reminderOn    Boolean        @default(false)
  userId        String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  user User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs HabitLog[]

  @@unique([userId, title, frequency])
  @@index([userId])
  @@index([reminderOn, reminderTime])
}

// ─────────────────────────────────────────────────────────────────
// HABIT LOG
// ─────────────────────────────────────────────────────────────────
model HabitLog {
  id        String   @id @default(uuid())
  habitId   String
  date      DateTime // normalized period timestamp (midnight daily / Monday weekly)
  completed Boolean  @default(true)
  note      String?
  createdAt DateTime @default(now())

  habit Habit @relation(fields: [habitId], references: [id], onDelete: Cascade)

  @@unique([habitId, date])
  @@index([habitId])
}

// ─────────────────────────────────────────────────────────────────
// AI INSIGHT CACHE
//
// One row per user. Stores generated insights + a SHA-256 hash
// of the data snapshot used to generate them.
//
// Cache hit:  current_hash == stored dataHash → return cached (no OpenAI call)
// Cache miss: current_hash != stored dataHash → regenerate and upsert
// ─────────────────────────────────────────────────────────────────
model AiInsight {
  id          String   @id @default(uuid())
  userId      String
  insights    Json
  dataHash    String
  generatedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@index([userId])
}
